/**
 * Poulet.js v0.0.0
 * (c) 2017 Alex Toudic
 * Released under MIT License.
 **/

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("lodash"),require("chirashi")):"function"==typeof define&&define.amd?define(["exports","lodash","chirashi"],t):t(e.Poulet=e.Poulet||{},e._,e.Chirashi)}(this,function(e,t,n){"use strict";function i(e,t,n){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}function o(e,t,i,r,s){t+=r,e[t]=[],Object.defineProperty(i,r,{get:function(){return s},set:function(c){s=c,"object"===("undefined"==typeof c?"undefined":a(c))&&n.forIn(c,o.bind(null,e,t+".",i[r])),n.forEach(e[t],function(e){e(s)})}}),i[r]=s}function r(e,t){return e?(e instanceof Array||(e=[e]),t instanceof Array||(t=[t]),[].concat(b(e),b(t))):t}function s(e,t){n.forIn(t,function(t,n){t in g?e[t]=g[t](e[t],n):e[t]=g.default(e[t],n)})}function c(e){var t=d({},e);return n.forEach(t.mixins,function(n,i){"string"==typeof n&&(n=_[n]),"mixins"in e&&(n=c(n)),s(t,n)}),t}function u(e){var t=[],i=!1,o=!1,r=!1,s=0,c=e.split(/\s/g);return n.forEach(c,function(e,n){var u=e.match(w);if(!i&&u&&(i=!0),o||e.indexOf("{")===-1||(o=!0,r=!0),o&&0===e.indexOf(",")&&(r=!0),!i&&!r){var a=e.match(j);a&&(a=a[0],isNaN(+a)&&(t.push(a),c[n]=e.replace(a,"$scope."+a)))}u&&(s+=u.length),u&&s%2===0&&(i=!1),o&&e.indexOf(":")!==-1&&(r=!1),o&&e.indexOf(",")!==-1&&(r=!0),o&&e.indexOf("}")!==-1&&(o=!1)}),{template:c.join(" "),props:t}}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},f=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},h=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},p=function e(t,n,i){null===t&&(t=Function.prototype);var o=Object.getOwnPropertyDescriptor(t,n);if(void 0===o){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,n,i)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(i)},$=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},v=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},b=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},y=function(){function e(t){f(this,e),this._observer=new MutationObserver(this._update.bind(this)),this._observer.observe(t,{childList:!0,subtree:!0}),this._listeners=[]}return h(e,[{key:"on",value:function(e){this._listeners.push(e)}},{key:"off",value:function(e){this._listeners.splice(this._listeners.indexOf(e),1)}},{key:"_update",value:function(){n.forEach(this._listeners,function(e){return e()})}}]),e}(),m=function(e,t){var n=t.split(".");t=n.pop();for(var i=n.length,o=0;o<i;++o)e=e[n[o]];return e[t]},_=Object.freeze({}),g={mounted:r,beforeDestroy:r,default:function(e,t){return"object"===("undefined"==typeof e?"undefined":a(e))&&"object"===("undefined"==typeof t?"undefined":a(t))?d({},t,e):e||t},mixins:function(e){return e}},k=["mounted","beforeDestroy"],O=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(this,e),Object.assign(this,t),this.$options=n,this.$id=this._generateId(),this.$options=c(this.$options),this.$scope={},this._bindLifeCycle(),this._bindData(),this._bindMethods()}return h(e,[{key:"_bindData",value:function(){var e=this;this.$data={},this._watchers={},n.forIn(this.$options.data,function(t,n){o(e._watchers,"",e.$data,t,n),i(t,e,e.$data),i(t,e.$scope,e.$data)})}},{key:"_bindMethods",value:function(){var e=this;this.$methods={},n.forIn(this.$options.methods,function(t,n){e.$methods[t]=n.bind(e)}),Object.assign(this,this.$methods),Object.assign(this.$scope,this.$methods)}},{key:"_generateId",value:function(){return t.uniqueId(""+this.$prefix+this.$options.name+"-")}},{key:"_bindLifeCycle",value:function(){var e=this;n.forEach(k,function(t){e[t]=function(){for(var i=arguments.length,o=Array(i),r=0;r<i;r++)o[r]=arguments[r];n.forEach(e.$options[t],function(t){return t.apply(e,o)})}})}},{key:"$watch",value:function(e,t){"function"==typeof t&&(t={deep:!1,immediate:!1,handler:t}),t.deep?n.forIn(this._watchers,function(n,i){0===n.indexOf(e)&&i.push(t.handler)}):e in this._watchers&&this._watchers[e].push(t.handler),t.immediate&&t.handler(m(this.$scope,e))}},{key:"$unwatch",value:function(e,t){n.forIn(this._watchers,function(e,n){n.splice(n.indexOf(t),1)})}},{key:"$mount",value:function(e){this.$el=n.getElement(e),this.$el[this.$marker]=this.$id,this.mounted(e)}},{key:"$destroy",value:function(){this.beforeDestroy()}}]),e}(),j=/([\w-_.\s]+)/g,w=/["']/g,x=["bind","update","unbind"],P=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(this,e),Object.assign(this,t),this.$options=n,this.$update=this.$update.bind(this),this.$id=this._generateId(),this._bindLifeCycle()}return h(e,[{key:"_generateId",value:function(){return t.uniqueId(""+this.$prefix+this.$options.name+"-")}},{key:"_bindLifeCycle",value:function(){var e=this;n.forEach(x,function(t){e[t]=function(){for(var i=arguments.length,o=Array(i),r=0;r<i;r++)o[r]=arguments[r];n.forEach(e.$options[t],function(t){return t.apply(e,o)})}})}},{key:"_eval",value:function(e){return(0,eval)("(function ($scope) { return "+e+"; })")(this.$scope)}},{key:"$bind",value:function(e,t){var i=this;this.$el=n.getElement(e),this.$option=u(t);for(var o=[this.$el].concat(b(n.parents(this.$el))),r=void 0,s=-1;(r=o[++s])&&!(this.$marker in r););this.$component=this.$components[r[this.$marker]],this.bind&&this.bind(e),this.$option.props.length?n.forEach(this.$option.props,function(e){i.$component.$watch(e,{immediate:!0,handler:i.$update})}):this.$update()}},{key:"$update",value:function(){this.update&&this.update(this._eval(this.$option.template))}},{key:"$unbind",value:function(){var e=this;n.forEach(this.$option.props,function(t){e.$component.$unwatch(t,e.$update)}),this.unbind&&this.unbind()}},{key:"$scope",get:function(){return this.$component.$scope}}]),e}(),C={bind:function(){this.currentClasses=[]},update:function(e){var t=void 0;"string"==typeof e?t=[e]:"length"in e?t=e:"object"===("undefined"==typeof e?"undefined":a(e))&&(t=Object.keys(e).filter(function(t){return e[t]}));var i=this.currentClasses.filter(function(e){return t.indexOf(e)===-1});n.addClass.apply(void 0,[this.$el].concat(b(t))),n.removeClass.apply(void 0,[this.$el].concat(b(i))),this.currentClasses=t}},E={update:function(e){n.setProp(this.$el,{innerHTML:e})}},I=function(e,t,n){var i=t.split(".");t=i.pop();for(var o=i.length,r=0;r<o;++r)e=e[i[r]];return e[t]=n},D={bind:function(e){var t=this;this.type=n.getProp(e,"type"),this.inputChanged=function(){var e=void 0;switch(t.type){case"checkbox":e=n.getProp(t.$el,"checked");break;default:e=n.getProp(t.$el,"value")}e!==t.currentValue&&(t.currentValue=e,I(t.$scope,t.model,t.currentValue))},this.offObj=n.on(e,{"keyup blur change":this.inputChanged})},update:function(e){if(e!==this.currentValue)switch(this.model=this.$option.props[0],this.currentValue=e,this.type){case"checkbox":console.log(this.$el.checked),n.setProp(this.$el,{checked:e}),console.log(this.$el.checked);break;case"radio":var t=this.$options.selector.slice(0,-1)+'="'+this.model+'"]';n.setProp(t,{checked:!1}),n.setProp(t+'[value="'+e+'"]',{checked:!0});break;default:n.setProp(this.$el,{value:e})}},unbind:function(){this.offObj.off()}},M={unbind:function(){this.offObj&&this.offObj.off()},update:function(e){this.offObj&&this.offObj.off(),console.log("on",e),n.on(this.$el,e)}},A={update:function(e){n.setStyle(this.$el,{display:e?"block":"none"})}},S={update:function(e){n.setProp(this.$el,{textContent:e})}},L=Object.freeze({Class:C,Html:E,Model:D,On:M,Show:A,Text:S}),V={$prefix:"by-"},q={name:"root"},T=function(e){function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(this,i),e=d({},V,e),t=d({},q,t);var o=v(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e,t));return o.$components=l({},o.$id,o),o.$directives={},o.$gobals=d({},e,t,{$root:o,$components:o.$components,$directives:o.$directives}),o.$gobals.$marker=o.$marker="_"+o.$prefix+"id",o.$directivesMarker="_"+o.$prefix+"directives",o._components=[],o._directives=[],n.forIn(L,o.directive.bind(o)),o}return $(i,e),h(i,[{key:"component",value:function(e,n){e=t.kebabCase(e);var i="selector"in n?n.selector:"["+this.$prefix+e+"]";this._components.push({selector:i,options:d({name:e,selector:i},n)})}},{key:"directive",value:function(e,n){e=t.kebabCase(e);var i="selector"in n?n.selector:"["+this.$prefix+e+"]";this._directives.push({selector:i,options:d({name:e,selector:i},n)})}},{key:"$mount",value:function(e){p(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"$mount",this).call(this,e),this._observer=new y(this.$el),this._observer.on(this._domChanged.bind(this)),this._domChanged()}},{key:"_domChanged",value:function(){this._unbindComponents(),this._unbindDirectives(),this._bindComponents(),this._bindDirectives()}},{key:"_unbindComponents",value:function(){var e=this;n.forIn(this.$components,function(t,i){n.closest(i.$el,document.body)||(i.$destroy(),delete e.$components[t])})}},{key:"_bindComponents",value:function(){var e=this;n.forEach(this._components,function(t){n.forEach(n.find(e.$el,t.selector),function(n){if(!(e.$marker in n)){var i=new O(e.$gobals,t.options);i.$mount(n),e.$components[i.$id]=i}})})}},{key:"_unbindDirectives",value:function(){var e=this;n.forIn(this.$directives,function(t,i){n.closest(i.$el,document.body)||(i.$unbind(),delete e.$directives[t])})}},{key:"_bindDirectives",value:function(){var e=this;n.forEach(this._directives,function(t){n.forEach(n.find(e.$el,t.selector),function(i){if(e.$directivesMarker in i){if(i[e.$directivesMarker].indexOf(t.options.name)!==-1)return}else i[e.$directivesMarker]=[];i[e.$directivesMarker].push(t.options.name);var o=new P(e.$gobals,t.options);o.$bind(i,n.getAttr(i,""+e.$gobals.$prefix+t.options.name)),e.$directives[o.$id]=o})})}}]),i}(O),z=Object.assign(T,{get:m,set:I});e.Poulet=z,Object.defineProperty(e,"__esModule",{value:!0})});